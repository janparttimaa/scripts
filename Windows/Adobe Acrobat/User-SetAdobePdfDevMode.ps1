<#
.SYNOPSIS
    Deploys a per-user printer DevMode blob for "Adobe PDF".

.DESCRIPTION
    This PowerShell script creates/updates the DevModePerUser registry value
    for the "Adobe PDF" printer under the current user hive.

    It writes the provided REG_BINARY data to:
    HKCU\Printers\DevModePerUser

    The setting applies per user and does not require administrative
    privileges to run.

    More information:
    https://helpx.adobe.com/acrobat/kb/fix-pdf-conversion-font-errors.html

.VERSION
    20251224

.AUTHOR
    Jan Parttimaa

.COPYRIGHT
    Â© 2025 Jan Parttimaa. All rights reserved.

.LICENSE
    This script is licensed under the MIT License.
    You may obtain a copy of the License at https://opensource.org/licenses/MIT

.RELEASE NOTES
    20251224 - Initial release

.EXAMPLE
    Run the following command with your non administrative user rights:

    powershell.exe -ExecutionPolicy Bypass -File .\User-SetAdobePdfDevMode.ps1

    This is the recommended execution method when deploying the script via
    Microsoft Intune, or Microsoft Configuration Manager.
#>

$ErrorActionPreference = "Stop"

# Target registry path and value
$RegPath   = "HKCU:\Printers\DevModePerUser"
$ValueName = "Adobe PDF"

# Full .reg-style payload (as provided)
$RegPayload = @'
[HKEY_CURRENT_USER\Printers\DevModePerUser]
"Adobe PDF"=hex:41,00,64,00,6f,00,62,00,65,00,20,00,50,00,44,00,46,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,01,04,03,06,dc,00,d4,\
  05,53,ef,81,01,01,00,01,00,ea,0a,6f,08,64,00,01,00,0f,00,b0,04,02,00,01,00,\
  b0,04,03,00,01,00,4c,00,65,00,74,00,74,00,65,00,72,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,01,00,00,00,00,00,00,00,01,00,00,00,02,00,00,00,\
  01,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,50,\
  52,49,56,e2,20,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,18,00,00,00,00,00,10,27,10,27,10,27,00,\
  00,10,27,00,00,00,00,00,00,00,00,b0,00,a4,03,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,03,00,00,00,00,00,00,00,30,02,10,\
  00,5c,4b,03,00,68,43,04,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,46,46,9f,f2,05,00,00,00,04,00,00,00,ff,\
  00,ff,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,01,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,b0,00,00,00,53,4d,54,4a,00,00,00,00,10,00,a0,00,41,00,64,00,\
  6f,00,62,00,65,00,20,00,50,00,44,00,46,00,20,00,43,00,6f,00,6e,00,76,00,65,\
  00,72,00,74,00,65,00,72,00,00,00,52,65,73,6f,6c,75,74,69,6f,6e,00,31,32,30,\
  30,64,70,69,00,50,61,67,65,53,69,7a,65,00,4c,65,74,74,65,72,00,50,61,67,65,\
  52,65,67,69,6f,6e,00,00,4c,65,61,64,69,6e,67,45,64,67,65,00,00,49,6e,70,75,\
  74,53,6c,6f,74,00,2a,55,73,65,46,6f,72,6d,54,72,61,79,54,61,62,6c,65,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,30,02,00,00,45,42,44,41,00,00,01,00,00,00,00,00,01,00,00,\
  00,01,00,00,00,01,00,00,00,00,00,00,00,53,00,74,00,61,00,6e,00,64,00,61,00,\
  72,00,64,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,01,00,00,00
'@

function Convert-RegHexToByteArray {
    param(
        [Parameter(Mandatory)]
        [string]$RegText
    )

    # Extract everything after "hex:" up to end (supports multi-line with "\" continuations)
    $m = [regex]::Match($RegText, 'hex:(?<hex>[\s\S]+)$', [System.Text.RegularExpressions.RegexOptions]::IgnoreCase)
    if (-not $m.Success) {
        throw "Could not locate 'hex:' payload in RegText."
    }

    $hexBlob = $m.Groups['hex'].Value

    # Remove .reg line continuations "\" and all whitespace
    $hexBlob = $hexBlob -replace '\\', ''
    $hexBlob = $hexBlob -replace '\s+', ''

    # Keep only hex digits and commas (defensive)
    $hexBlob = $hexBlob -replace '[^0-9a-fA-F,]', ''

    # Split by comma, convert each to byte
    $parts = $hexBlob.Split(',', [System.StringSplitOptions]::RemoveEmptyEntries)
    if ($parts.Count -lt 1) { throw "Hex payload parsed to zero bytes." }

    $bytes = New-Object byte[] ($parts.Count)
    for ($i = 0; $i -lt $parts.Count; $i++) {
        $bytes[$i] = [Convert]::ToByte($parts[$i], 16)
    }
    return $bytes
}

try {
    # Build expected bytes from the embedded payload
    $ExpectedData = Convert-RegHexToByteArray -RegText $RegPayload

    # Ensure key exists
    if (-not (Test-Path $RegPath)) {
        New-Item -Path $RegPath -Force | Out-Null
    }

    # Write REG_BINARY
    New-ItemProperty -Path $RegPath -Name $ValueName -PropertyType Binary -Value $ExpectedData -Force | Out-Null

    # Verify: length + byte-for-byte compare
    $ActualData = (Get-ItemProperty -Path $RegPath -Name $ValueName -ErrorAction Stop).$ValueName

    $sameLength = ($ActualData.Length -eq $ExpectedData.Length)
    $sameBytes  = $sameLength

    if ($sameLength) {
        for ($i = 0; $i -lt $ExpectedData.Length; $i++) {
            if ($ActualData[$i] -ne $ExpectedData[$i]) { $sameBytes = $false; break }
        }
    }

    if ($sameBytes) {
        Write-Output "SUCCESS: '$ValueName' written to $RegPath (REG_BINARY, $($ActualData.Length) bytes)."
        exit 0
    } else {
        Write-Error "FAILURE: '$ValueName' data mismatch. Expected $($ExpectedData.Length) bytes, got $($ActualData.Length) bytes."
        exit 1
    }
}
catch {
    Write-Error "FAILURE: $($_.Exception.Message)"
    exit 1
}
